#! /bin/sh
EmbedMAS_TMP=/tmp/.embedMAS
mkdir -p $EmbedMAS_TMP

while getopts f:m:i:-: flag 
    do
    case "${flag}" in
        f) file=${OPTARG};;             # file .mas2j, .jcm, or .zip
        m) memory=${OPTARG};;           # Heap memory in MB
        i) interpreter=${OPTARG};;      # jason | jasonEmbedded | jacamo
        -) opt=${OPTARG};;              # --start, --stop, --import
    esac
done

[ -z "$interpreter" ] && interpreter="jasonEmbedded"

case "$interpreter" in
    jason|jasonEmbedded|jacamo)
        ;;
    *)
        echo "Unsupported Interpreter: $interpreter" >&2
        echo "Use: -i jason | -i jasonEmbedded | -i jacamo" >&2
        exit 1
        ;;
esac

EXEC="/usr/local/bin/$interpreter"


memoryUSAGE(){
    # Parâmetros da política
    OS_MIN_SMALL=256   # reserva pro SO quando RAM < 1GB
    OS_MIN_BIG=512     # reserva pro SO quando RAM >= 1GB
    THRESHOLD=1025     # 1 GB em MiB
    MAS_MIN=128        # mínimo de heap pro MAS
    SAFETY_OS_MIN=64   # mínimo absoluto de RAM pro SO em cenários extremos

    # Lê MemTotal em MiB (MemTotal vem em KiB)
    TOTAL_MEM=`cat /proc/meminfo | grep MemTotal | xargs | cut -d " " -f 2 | numfmt --from-unit=Ki --to-unit=Mi`

    # Calcula memória alvo para o MAS conforme política
    if [ "$TOTAL_MEM" -lt "$THRESHOLD" ]; then
        MEMORY=$(( TOTAL_MEM - OS_MIN_SMALL ))
    else
        MEMORY=$(( TOTAL_MEM - OS_MIN_BIG ))
    fi

    # Garante um mínimo para o MAS
    if [ "$MEMORY" -lt "$MAS_MIN" ]; then
        MEMORY=$MAS_MIN
    fi

    # Evita valores negativos ou absurdos:
    # - nunca menos que 32 MiB
    # - nunca tão grande a ponto de sobrar menos que SAFETY_OS_MIN pro SO
    if [ "$MEMORY" -lt 32 ]; then
        MEMORY=32
    fi

    MAX_FOR_MAS=$(( TOTAL_MEM - SAFETY_OS_MIN ))
    if [ "$MEMORY" -gt "$MAX_FOR_MAS" ]; then
        MEMORY=$MAX_FOR_MAS
    fi

    echo "$MEMORY" > "$EmbedMAS_TMP/memory2MAS"

}



if [ "$opt" = "start" ]; then
    pid=`cat $EmbedMAS_TMP/embeddedMAS.pid 2> /dev/null`

    if [ "$file" = "" ]
        then
            file=/root/EmbeddedMAS/*.mas2j
    fi

    if [ "$pid" = "" ]
    then
        if [ "$memory" = "" ]
        then
            memoryUSAGE
        else
            echo "$memory" > "$EmbedMAS_TMP/memory2MAS"
        fi
        
        directory="$(dirname "${file}")" 
        cd $directory
        /usr/bin/chonos-log -e " "
        /usr/bin/chonos-log -e "[ChonOS EmbeddedMAS] Starting the Multi-Agent System..."
        #        /usr/bin/jasonEmbedded $file -Xms$memory"m" >> $EmbedMAS_TMP/embeddedMAS.log 2>> $EmbedMAS_TMP/embeddedMAS.log &
        $EXEC $file >> $EmbedMAS_TMP/embeddedMAS.log 2>> $EmbedMAS_TMP/embeddedMAS.log &

        pid=`ps -ax | grep java | grep $file | xargs | cut -d " " -f 1`
        echo $pid > $EmbedMAS_TMP/embeddedMAS.pid

        subdomain=`cat /opt/group.chon/conf/ddns.conf | cut -d ":" -f 1`
        echo "{ \"message\" : \"Starting the Multi-Agent System, process $pid\","
        echo "  \"logmonitor\":\"http://$subdomain.bot.chon.group:3271\","
        echo "  \"mindmonitor\":\"http://$subdomain.bot.chon.group:3272\"}"
    else
        /usr/bin/chonosEmbeddedMAS --stop -f $file
        /usr/bin/chonosEmbeddedMAS --start -f $file
    fi
elif [ "$opt" = "stop" ]; then
    
    if [ "$file" = "" ]
        then
            file=/root/EmbeddedMAS/*.mas2j
    fi

    pid=`cat $EmbedMAS_TMP/embeddedMAS.pid 2> /dev/null`
    if [ "$pid" != "" ]; then
        DIR=$(dirname "$file")
        touch $DIR/.stop___MAS
        /usr/bin/chonos-log -e "[ChonOS EmbeddedMAS] Stopping the Multi-agent System Gently..."
        exec=`ps $pid | grep $pid | xargs | cut -d " " -f 1`
        round=3
        while [ "$exec" = "$pid" ]
        do
            sleep 1
            exec=`ps $pid | grep $pid | xargs | cut -d " " -f 1`
            if [ $round -eq 0 ]
            then
                /usr/bin/chonos-log -e "[ChonOS EmbeddedMAS] Killing the Multi-Agent System..."
                kill -9 $pid
            fi
            round=$((round-1))
        done
        /usr/bin/chonos-log -e "[ChonOS EmbeddedMAS] Multi-Agent System Successfully Terminated!"
        rm -rf $EmbedMAS_TMP/embeddedMAS.pid
        echo "{ \"message\" : \"Stopping the Multi-Agent System, process $pid\"}"
    else
        echo "{ \"message\" : \"There is no Multi-Agent System in execution!\"}"
    fi
elif [ "$opt" = "import" ]; then
    if [ "$file" != "" ]; then
        rm -rf $EmbedMAS_TMP/embeddedmasIN
        mkdir -p $EmbedMAS_TMP/embeddedmasIN
        unzip $file -d $EmbedMAS_TMP/embeddedmasIN/
        mas2jFile=`find $EmbedMAS_TMP/embeddedmasIN/ | grep .mas2j | tail -1 | xargs`
        directory="$(dirname "${mas2jFile}")"
        rm -rf /root/EmbeddedMAS/*
        mv $directory/* /root/EmbeddedMAS/
        /usr/bin/chonos-log -e "[ChonOS EmbeddedMAS] The Multi-Agent Was Imported!"
    fi
else
	echo "Consult tutorial at: https://github.com/chon-group/dpkg-chonos-embeddedmas"
    exit 0
fi
